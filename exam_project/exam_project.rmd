---
title: "R Notebook"
output: html_notebook
---
```{r echo=FALSE, warning=FALSE}
library(readxl)
library(survival)
library(survminer)
```

# Part A
## Question 1

```{r}
std <- read_xlsx('data/std_2019_pw.xlsx')

kmp<-survfit(Surv(std$time,std$cens)~std$type,type="kaplan-meier")

ggsurv <- ggsurvplot(kmp , data = std, xlab="Days to re-infection",
                     ylab="Survival estimate",
                     legend.labs = c("Gonorrhea", "Chlamydia","Both"), linetype = 'strata') + 
  labs(title    = "Survival estimates for time to re-infection",
       subtitle = "Based on Kaplan-Meier estimates")

ggsurv <- ggpar(ggsurv, font.title    = c(14, "bold"),
                font.subtitle = c(12, "bold.italic"),        
                font.x        = c(11, "plain"),          
                font.y        = c(11, "plain"))

print(ggsurv)
```

From Figure 1 we can see that Chlamydia has an overall higher survival rate in terms of re-infection than does Gonorrhea.  A person who has been infected with both appears to lie in between the two singular infections, perhaps being pulled up by the higher survival rate of Chlamydia

## Question 2

```{r}
library(ggfortify)

write.csv(fortify(kmp),file = 'std_summary.csv')

print(0.747803 + (qnorm(0.975,0,1)*0.071121))
print(0.747803  - (qnorm(0.975,0,1)*0.071121))

print(0.484982 + (qnorm(0.975,0,1)*0.133869))
print(0.484982 - (qnorm(0.975,0,1)*0.133869))

print(0.205888 + (qnorm(0.975,0,1)*0.343699))
print(0.205888 - (qnorm(0.975,0,1)*0.343699))

print(0.746184802 + (qnorm(0.975,0,1)*0.045501))
print(0.746184802 - (qnorm(0.975,0,1)*0.045501))

print(0.491433433 + (qnorm(0.975,0,1)*0.106618))
print(0.491433433 - (qnorm(0.975,0,1)*0.106618))

print(0.748251879 + (qnorm(0.975,0,1)*0.043361))
print(0.748251879 - (qnorm(0.975,0,1)*0.043361))

print(0.488086846 + (qnorm(0.975,0,1)*0.092543))
print(0.488086846 - (qnorm(0.975,0,1)*0.092543))

print(0.2395865 + (qnorm(0.975,0,1)*0.23866))
print(0.2395865 - (qnorm(0.975,0,1)*0.23866))
```

Highlight biggest time where S(t) is just smaller than 0.75,0.5,0.25 for each infection type.

## Question 4
```{r}
dif <- survdiff(Surv(std$time,std$cens)~std$type,rho = 0)

a <- c(3,2,1)
z <- c(8.366,-15.324,6.958)

az <- a%*%z
az

aaz <- t(a)%*%dif$var%*%a
aaz
az/sqrt(aaz[[1]])

1-pnorm(az/sqrt(aaz[[1]]))
```
## Question 5
### a

```{r}
std_rr <- read.csv('data/std_2019_pw_rr.csv')

cox <- coxph(Surv(std_rr$time, std_rr$cens)~std_rr$type_both+std_rr$type_chl, method = 'breslow')
cox
```
```{r}
exp(-0.04813+(1.96*0.06912))
exp(-0.04813-(1.96*0.06912))
exp(0.00233+(1.96*0.0004181))
exp(0.00233-(1.96*0.0004181))
```

```{r}
res<-residuals(cox)
cox_snell<-(std_rr$cens-res)

aa <- Surv(std_rr$time, std_rr$cens)

plot(aa,fun="cumhaz",main="Cox-Snell residual plot",xlab="residuals",ylab="estimated cumulative H(t)")
abline(0,1,lty=6)

# Stratifying on initial infection type
surv_obj_strat <- Surv(cox_snell,std_rr$cens)~std_rr$type

aa_strat <-survfit(surv_obj_strat,conf.type = 'none')

plot(aa_strat,fun="cumhaz",main="Cox-Snell residual plot",xlab="residuals",ylab="estimated cumulative H(t)",lty=c(1,2))
abline(0,1,lty=6)
legend(legend=c('Aneuploid','Diploid','45` Line'),lty = c(1,2,6),'topright')

```
```{r}
kmp<-survfit(Surv(std$time,std$cens)~std$type+std$condom, subset = std$type==1,type="kaplan-meier")

ggsurv <- ggsurvplot(kmp , data = std, xlab="Days to re-infection",
                     ylab="Survival estimate",
                     legend.labs = c("Gonorrhea-No_Condom","Gonorrhea-Condom_Always"), linetype = 'strata') + 
  labs(title    = "Survival estimates for time to re-infection",
       subtitle = "Based on Kaplan-Meier estimates")

ggsurv <- ggpar(ggsurv, font.title    = c(14, "bold"),
                font.subtitle = c(12, "bold.italic"),        
                font.x        = c(11, "plain"),          
                font.y        = c(11, "plain"))

print(ggsurv)
```

```{r}
std <- read_xlsx('data/std_2019_pw.xlsx')

kmp<-survfit(Surv(std$time,std$cens)~std$type+std$condom, subset = std$type==2,type="kaplan-meier")

ggsurv <- ggsurvplot(kmp , data = std, xlab="Days to re-infection",
                     ylab="Survival estimate",
                     legend.labs = c("Both-No_Condom","Both-Condom_Always"), linetype = 'strata') + 
  labs(title    = "Survival estimates for time to re-infection",
       subtitle = "Based on Kaplan-Meier estimates")

ggsurv <- ggpar(ggsurv, font.title    = c(14, "bold"),
                font.subtitle = c(12, "bold.italic"),        
                font.x        = c(11, "plain"),          
                font.y        = c(11, "plain"))

print(ggsurv)

```

```{r}
kmp<-survfit(Surv(std$time,std$cens)~std$type+std$condom, subset = std$type==3,type="kaplan-meier")

ggsurv <- ggsurvplot(kmp , data = std, xlab="Days to re-infection",
                     ylab="Survival estimate",
                     legend.labs = c("Chlamydia-No_Condom","Chlamydia-Condom_Always"), linetype = 'strata') + 
  labs(title    = "Survival estimates for time to re-infection",
       subtitle = "Based on Kaplan-Meier estimates")

ggsurv <- ggpar(ggsurv, font.title    = c(14, "bold"),
                font.subtitle = c(12, "bold.italic"),        
                font.x        = c(11, "plain"),          
                font.y        = c(11, "plain"))

print(ggsurv)
```




